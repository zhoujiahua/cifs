{{extend "./../layout/layout.html"}}
{{block "style"}}

{{/block}}
{{block "content"}}
<div class="layui-tab page-content-wrap">
	<ul class="layui-tab-title">
		<li class="layui-this">站点配置</li>
		<li>SEO配置</li>
		<li>邮箱配置</li>
		<li>评论设置</li>
	</ul>
	<div class="layui-tab-content">
		<!--站点配置-->
		<div class="layui-tab-item layui-show">
			<form class="layui-form" lay-filter="webConfig" style="width: 90%;padding-top: 20px;">
				<div class="layui-form-item">
					<label class="layui-form-label">网站名称：</label>
					<div class="layui-input-block">
						<input type="text" name="webname" class="layui-input">
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">网站域名：</label>
					<div class="layui-input-block">
						<input type="text" name="domain" class="layui-input">
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">站长邮箱：</label>
					<div class="layui-input-block">
						<input type="text" name="email" required lay-verify="required" placeholder="请输入联系邮箱"
							class="layui-input">
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">是否缓存：</label>
					<div class="layui-input-block">
						<input type="checkbox" name="cache" lay-skin="switch" lay-filter="switchTest" lay-text="ON|OFF">
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">静态首页：</label>
					<div class="layui-input-block">
						<input type="radio" name="static" value="1" title="生成" checked="">
						<input type="radio" name="static" value="0" title="不生成">
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">备案信息：</label>
					<div class="layui-input-block">
						<input type="text" name="icp" required lay-verify="required" placeholder="请输入备案信息"
							class="layui-input">
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">版权信息：</label>
					<div class="layui-input-block">
						<input type="text" name="copyright" required lay-verify="required" placeholder="请输入版权信息"
							class="layui-input">
					</div>
				</div>
				<div class="layui-form-item layui-form-text">
					<label class="layui-form-label">统计代码：</label>
					<div class="layui-input-block">
						<textarea name="desc" placeholder="请输入代码" class="layui-textarea"></textarea>
					</div>
				</div>
				<div class="layui-form-item">
					<div class="layui-input-block">
						<button class="layui-btn layui-btn-normal" lay-submit lay-filter="siteInfo">立即提交</button>
					</div>
				</div>
			</form>
		</div>
		<!--SEO配置-->
		<div class="layui-tab-item">
			<form class="layui-form" lay-filter="webSeo" style="width: 90%;padding-top: 20px;">
				<div class="layui-form-item">
					<label class="layui-form-label">SEO标题：</label>
					<div class="layui-input-block">
						<input type="text" name="title" placeholder="请输入seo标题" class="layui-input">
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">关键字：</label>
					<div class="layui-input-block">
						<input type="text" name="keyword" placeholder="请输入seo关键字" class="layui-input">
					</div>
				</div>
				<div class="layui-form-item layui-form-text">
					<label class="layui-form-label">描述：</label>
					<div class="layui-input-block">
						<textarea name="desc" placeholder="请输入seo描述" class="layui-textarea"></textarea>
					</div>
				</div>
				<div class="layui-form-item">
					<div class="layui-input-block">
						<button class="layui-btn layui-btn-normal" lay-submit lay-filter="seoInfo">立即提交</button>
					</div>
				</div>
			</form>
		</div>
		<!--邮箱配置-->
		<div class="layui-tab-item">
			<form class="layui-form" lay-filter="webEmail" style="width: 90%;padding-top: 20px;">
				<div class="layui-form-item">
					<label class="layui-form-label">邮箱模式：</label>
					<div class="layui-input-block">
						<input type="radio" name="pattern" value="0" title="SMTP函数发送">
						<input type="radio" name="pattern" value="1" title="其他发送模式">
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">服务器：</label>
					<div class="layui-input-block">
						<input type="text" name="smtp" placeholder="请输入邮件服务器" class="layui-input">
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">端口：</label>
					<div class="layui-input-block">
						<input type="text" name="port" placeholder="请输入邮件发送端口" class="layui-input">
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">发件人：</label>
					<div class="layui-input-block">
						<input type="text" name="addresser" placeholder="请输入发件人地址" class="layui-input">
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">名称：</label>
					<div class="layui-input-block">
						<input type="text" name="uname" placeholder="请输入发件人名称" class="layui-input">
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">用户名：</label>
					<div class="layui-input-block">
						<input type="text" name="username" placeholder="请输入用户名" class="layui-input">
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">密码：</label>
					<div class="layui-input-block">
						<input type="password" name="password" placeholder="请输入密码" class="layui-input">
					</div>
				</div>
				<div class="layui-form-item">
					<div class="layui-input-block">
						<button class="layui-btn layui-btn-normal" lay-submit lay-filter="emailInfo">立即提交</button>
					</div>
				</div>
			</form>
		</div>
		<!--评论设置-->
		<div class="layui-tab-item">
			<form class="layui-form" lay-filter="webComment" style="width: 90%;padding-top: 20px;">
				<div class="layui-form-item">
					<label class="layui-form-label">评论审核：</label>
					<div class="layui-input-block">
						<input type="checkbox" name="audit" lay-skin="primary" title="开启" checked="">
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">评论间隔：</label>
					<div class="layui-input-inline">
						<input type="text" name="utime" placeholder="请输入评论时间间隔" class="layui-input">
					</div>
					<div class="layui-form-mid layui-word-aux">秒</div>
				</div>
				<div class="layui-form-item">
					<div class="layui-input-block">
						<button class="layui-btn layui-btn-normal" lay-submit lay-filter="commentInfo">立即提交</button>
					</div>
				</div>
			</form>
		</div>
	</div>
</div>
{{/block}}

{{block "script"}}
<script>
	layui.use(['form', 'element'], function () {
		var form = layui.form,
			element = layui.element,
			$ = layui.$,
			indexLoad = null,
			timer = null,
			webInfo = layui.sessionData("webInfo").data.data[0],
			webConfig = webInfo.web_config,
			webSeo = webInfo.seo_config,
			webEmail = webInfo.email_config,
			webComment = webInfo.comment_config;

		//站点信息提交
		form.on('submit(siteInfo)', function (data) {
			var d = data.field,
				web_config = {
					_id: webInfo._id,
					types: "1",
					web_name: d.webname,
					web_domain: d.domain,
					web_email: d.email,
					is_cache: d.cache ? true : false,
					is_static: parseInt(d.static) ? true : false,
					web_icp: d.icp,
					web_copyright: d.copyright,
					web_statistical: d.desc
				}

			//信息提交
			$.ajax({
				type: "POST",
				url: "/api/admin/comm/web/edit",
				data: web_config,
				dataType: "json",
				beforeSend: function () {
					indexLoad = layer.load(1, {
						shade: [0.4, '#fff']
					});
				},
				success: function (res) {
					console.log(res)
					if (res.code) {
						timer = setTimeout(function () {
							layer.msg(res.msg, {
								icon: 2,
								time: 1000
							}, function () {
								clearTimeout(timer);
								layer.close(indexLoad);
								return false;
							})
						}, 600)
					} else {
						timer = setTimeout(function () {
							layer.msg(res.msg, {
								icon: 1,
								time: 1000
							}, function () {
								clearTimeout(timer);
								layer.close(indexLoad);

								return false;
							})
						}, 600)
					}
				}
			});
			return false;
		});
		//监听seo提交
		form.on('submit(seoInfo)', function (data) {
			var d = data.field,
				seo_config = {
					_id: webInfo._id,
					types: "2",
					seo_title: d.title,
					seo_keys: d.keyword,
					seo_desc: d.desc
				}

			//信息提交
			$.ajax({
				type: "POST",
				url: "/api/admin/comm/web/edit",
				data: seo_config,
				dataType: "json",
				beforeSend: function () {
					indexLoad = layer.load(1, {
						shade: [0.4, '#fff']
					});
				},
				success: function (res) {
					console.log(res)
					if (res.code) {
						timer = setTimeout(function () {
							layer.msg(res.msg, {
								icon: 2,
								time: 1000
							}, function () {
								clearTimeout(timer);
								layer.close(indexLoad);
								return false;
							})
						}, 600)
					} else {
						timer = setTimeout(function () {
							layer.msg(res.msg, {
								icon: 1,
								time: 1000
							}, function () {
								clearTimeout(timer);
								layer.close(indexLoad);

								return false;
							})
						}, 600)
					}
				}
			});
			return false;
		});

		//邮箱配置
		form.on('submit(emailInfo)', function (data) {
			var d = data.field,
				email_config = {
					_id: webInfo._id,
					types: "3",
					email_pattern: d.pattern,
					email_server: d.smtp,
					email_port: d.port,
					email_addresser: d.addresser,
					email_name: d.uname,
					email_user: d.username,
					email_pass: d.password
				}

			//信息提交
			$.ajax({
				type: "POST",
				url: "/api/admin/comm/web/edit",
				data: email_config,
				dataType: "json",
				beforeSend: function () {
					indexLoad = layer.load(1, {
						shade: [0.4, '#fff']
					});
				},
				success: function (res) {
					console.log(res)
					if (res.code) {
						timer = setTimeout(function () {
							layer.msg(res.msg, {
								icon: 2,
								time: 1000
							}, function () {
								clearTimeout(timer);
								layer.close(indexLoad);
								return false;
							})
						}, 600)
					} else {
						timer = setTimeout(function () {
							layer.msg(res.msg, {
								icon: 1,
								time: 1000
							}, function () {
								clearTimeout(timer);
								layer.close(indexLoad);

								return false;
							})
						}, 600)
					}
				}
			});
			return false;
		});
		//评论提交
		form.on('submit(commentInfo)', function (data) {
			var d = data.field,
				comment_config = {
					_id: webInfo._id,
					types: "4",
					is_open: d.audit ? true : false,
					comment_time: d.utime,
				}

			//信息提交
			$.ajax({
				type: "POST",
				url: "/api/admin/comm/web/edit",
				data: comment_config,
				dataType: "json",
				beforeSend: function () {
					indexLoad = layer.load(1, {
						shade: [0.4, '#fff']
					});
				},
				success: function (res) {
					console.log(res)
					if (res.code) {
						timer = setTimeout(function () {
							layer.msg(res.msg, {
								icon: 2,
								time: 1000
							}, function () {
								clearTimeout(timer);
								layer.close(indexLoad);
								return false;
							})
						}, 600)
					} else {
						timer = setTimeout(function () {
							layer.msg(res.msg, {
								icon: 1,
								time: 1000
							}, function () {
								clearTimeout(timer);
								layer.close(indexLoad);

								return false;
							})
						}, 600)
					}
				}
			});
			return false;
		});

		//站点配置
		form.val("webConfig", {
			webname: webConfig.web_name,
			domain: webConfig.web_domain,
			email: webConfig.web_email,
			cache: webConfig.is_cache,
			static: webConfig.is_static ? 1 : 0,
			icp: webConfig.web_icp,
			copyright: webConfig.web_copyright,
			desc: webConfig.web_statistical
		})
		//站点SEO
		form.val("webSeo", {
			title: webSeo.seo_title,
			keyword: webSeo.seo_keys,
			desc: webSeo.seo_desc
		})
		//站点邮箱配置
		form.val("webEmail", {
			pattern: webEmail.email_pattern,
			smtp: webEmail.email_server,
			port: webEmail.email_port,
			addresser: webEmail.email_addresser,
			uname: webEmail.email_name,
			username: webEmail.email_user,
			password: webEmail.email_pass
		})

		//评论配置
		form.val("webComment", {
			audit: webComment.is_open,
			utime: webComment.comment_time
		})

		form.render();
	});
</script>
{{/block}}